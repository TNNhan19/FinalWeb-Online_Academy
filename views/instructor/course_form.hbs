{{#section "head"}}
<script
  src="https://cdn.tiny.cloud/1/85smk8b6yiwa040bb9wgiz48khuw8tkx41hxez1g4hfsx7ff/tinymce/6/tinymce.min.js"
  referrerpolicy="origin"
></script>
{{/section}}

<h4 class="mb-4">
  {{#if isNew}}ƒêƒÉng kh√≥a h·ªçc m·ªõi{{else}}C·∫≠p nh·∫≠t kh√≥a h·ªçc{{/if}}
</h4>

<form method="POST" action="" class="row g-4">
  <div class="col-lg-8">
    <div class="card border-0 shadow-sm p-4">
      <div class="mb-3">
        <label class="form-label fw-semibold">Ti√™u ƒë·ªÅ kh√≥a h·ªçc</label>
        <input name="title" class="form-control" value="{{course.title}}" required>
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold">M√¥ t·∫£ ng·∫Øn</label>
        <textarea name="description" class="form-control" rows="2" placeholder="T√≥m t·∫Øt ng·∫Øn g·ªçn v·ªÅ kh√≥a h·ªçc">{{course.description}}</textarea>
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold">N·ªôi dung chi ti·∫øt</label>
        <textarea id="editor" name="detail_html">{{course.detail_html}}</textarea>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card border-0 shadow-sm p-4">
      {{#if instructors}}
      <div class="mb-3">
        <label class="form-label fw-semibold">Gi·∫£ng vi√™n</label>
        <select name="instructor_id" class="form-select" required>
          <option value="">-- Ch·ªçn gi·∫£ng vi√™n --</option>
          {{#each instructors}}
          <option value="{{instructor_id}}" {{#if (eq instructor_id ../course.instructor_id)}}selected{{/if}}>
            {{name}}
          </option>
          {{/each}}
        </select>
      </div>
      {{/if}}

      <div class="mb-3">
        <label class="form-label fw-semibold">Danh m·ª•c</label>
        <select name="category_id" class="form-select" required>
          <option value="">-- Ch·ªçn lƒ©nh v·ª±c --</option>
          {{#each categories}}
          <option value="{{category_id}}" {{#if (eq category_id ../course.category_id)}}selected{{/if}}>
            {{name}}
          </option>
          {{/each}}
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold">·∫¢nh ƒë·∫°i di·ªán (URL)</label>
        <input name="image_url" class="form-control" value="{{course.image_url}}" placeholder="https://...">
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold">T·ªïng th·ªùi l∆∞·ª£ng (gi·ªù)</label>
        <input name="total_hours" type="number" step="0.5" class="form-control" value="{{course.total_hours}}">
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold">T·ªïng s·ªë b√†i gi·∫£ng</label>
        <input name="total_lectures" type="number" class="form-control" value="{{course.total_lectures}}">
      </div>

      <div class="row">
        <div class="col-md-6">
          <label class="form-label fw-semibold">Gi√° g·ªëc ($)</label>
          <input name="original_price" type="number" step="0.01" class="form-control" value="{{course.original_price}}">
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">Gi√° khuy·∫øn m√£i ($)</label>
          <input name="current_price" type="number" step="0.01" class="form-control" value="{{course.current_price}}">
        </div>
      </div>

      {{#unless isNew}}
      <div class="mt-3">
        <label class="form-label fw-semibold">Tr·∫°ng th√°i kh√≥a h·ªçc</label>
        <select name="status" class="form-select">
          <option value="incomplete" {{#if (eq course.status "incomplete")}}selected{{/if}}>Ch∆∞a ho√†n th√†nh</option>
          <option value="complete" {{#if (eq course.status "complete")}}selected{{/if}}>ƒê√£ ho√†n th√†nh</option>
        </select>
      </div>
      {{/unless}}

      <button type="submit" class="btn btn-primary mt-4 w-100">üíæ L∆∞u kh√≥a h·ªçc</button>
    </div>
  </div>
</form>

{{#unless isNew}}
<hr class="my-5">
<h5 class="fw-semibold mb-3">üé¨ Qu·∫£n l√Ω ch∆∞∆°ng & b√†i gi·∫£ng</h5>

<form id="structureForm">
  <input type="hidden" name="course_id" value="{{course.course_id}}">

  <div id="sectionsContainer">
    {{#each sections}}
    <div class="card mb-4 border-0 shadow-sm section-item" data-section-id="{{section_id}}">
      <div class="card-header bg-light">
        <input class="form-control form-control-sm fw-semibold section-title" value="{{title}}">
      </div>
      <div class="card-body lectures-container">
        {{#each ../lectures}}
          {{#if (eq section_id ../section_id)}}
          <div class="d-flex align-items-center gap-2 mb-2 lecture-item" data-lecture-id="{{lecture_id}}">
            <input class="form-control form-control-sm flex-fill lecture-title" value="{{title}}" placeholder="T√™n b√†i gi·∫£ng">
            <input class="form-control form-control-sm flex-fill lecture-video" value="{{video_url}}" placeholder="Video URL">
            <input class="form-control form-control-sm lecture-duration" type="number" value="{{duration}}" placeholder="Th·ªùi l∆∞·ª£ng (s)">
            <div class="form-check">
              <input class="form-check-input lecture-preview" type="checkbox" {{#if is_preview}}checked{{/if}}>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger remove-lecture">üóëÔ∏è</button>
          </div>
          {{/if}}
        {{/each}}
        <button type="button" class="btn btn-sm btn-outline-success mt-2 add-lecture">+ Th√™m b√†i gi·∫£ng</button>
      </div>
    </div>
    {{/each}}
  </div>

  <div class="d-flex gap-2 my-3">
    <input id="newSectionTitle" class="form-control" placeholder="T√™n ch∆∞∆°ng m·ªõi">
    <button type="button" id="addSectionBtn" class="btn btn-outline-primary">+ Th√™m ch∆∞∆°ng</button>
  </div>

  <div class="text-end">
    <button type="submit" class="btn btn-success px-4">üíæ L∆∞u t·∫•t c·∫£ thay ƒë·ªïi</button>
  </div>
</form>
{{/unless}}

{{#section "js"}}
<script>
tinymce.init({
  selector: '#editor',
  height: 400,
  menubar: false,
  branding: false,
  plugins: 'lists link image media table code help wordcount',
  toolbar:
    'undo redo | styles | bold italic underline | alignleft aligncenter alignright | bullist numlist | link image media | code',
});

// === Qu·∫£n l√Ω th√™m/x√≥a ch∆∞∆°ng v√† b√†i gi·∫£ng ===
document.getElementById("addSectionBtn")?.addEventListener("click", () => {
  const title = document.getElementById("newSectionTitle").value.trim();
  if (!title) return alert("Vui l√≤ng nh·∫≠p t√™n ch∆∞∆°ng!");
  const div = document.createElement("div");
  div.className = "card mb-4 border-0 shadow-sm section-item";
  div.innerHTML = `
    <div class="card-header bg-light">
      <input class="form-control form-control-sm fw-semibold section-title" value="${title}">
    </div>
    <div class="card-body lectures-container">
      <button type="button" class="btn btn-sm btn-outline-success mt-2 add-lecture">+ Th√™m b√†i gi·∫£ng</button>
    </div>`;
  document.getElementById("sectionsContainer").appendChild(div);
  document.getElementById("newSectionTitle").value = "";
});

document.addEventListener("click", (e) => {
  if (e.target.classList.contains("add-lecture")) {
    const container = e.target.closest(".lectures-container");
    const div = document.createElement("div");
    div.className = "d-flex align-items-center gap-2 mb-2 lecture-item";
    div.innerHTML = `
      <input class="form-control form-control-sm flex-fill lecture-title" placeholder="T√™n b√†i gi·∫£ng">
      <input class="form-control form-control-sm flex-fill lecture-video" placeholder="Video URL">
      <input class="form-control form-control-sm lecture-duration" type="number" placeholder="Th·ªùi l∆∞·ª£ng (s)">
      <div class="form-check">
        <input class="form-check-input lecture-preview" type="checkbox">
      </div>
      <button type="button" class="btn btn-sm btn-outline-danger remove-lecture">üóëÔ∏è</button>`;
    container.insertBefore(div, e.target);
  }

  if (e.target.classList.contains("remove-lecture")) {
    e.target.closest(".lecture-item").remove();
  }
});

// === G·ª≠i t·∫•t c·∫£ thay ƒë·ªïi ===
document.getElementById("structureForm")?.addEventListener("submit", async (e) => {
  e.preventDefault();
  const courseId = e.target.querySelector("[name='course_id']").value;
  const sections = [...document.querySelectorAll(".section-item")].map((section) => ({
    section_id: section.dataset.sectionId || null,
    title: section.querySelector(".section-title").value,
    lectures: [...section.querySelectorAll(".lecture-item")].map((lec) => ({
      lecture_id: lec.dataset.lectureId || null,
      title: lec.querySelector(".lecture-title").value,
      video_url: lec.querySelector(".lecture-video").value,
      duration: lec.querySelector(".lecture-duration").value,
      is_preview: lec.querySelector(".lecture-preview").checked,
    })),
  }));

  const res = await fetch(`/instructor/update-structure/${courseId}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ sections }),
  });
  const data = await res.json();
  alert(data.message || "ƒê√£ l∆∞u thay ƒë·ªïi!");
});
</script>
{{/section}}
