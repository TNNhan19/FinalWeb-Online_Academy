<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Khoá học của tôi</h2>
        <div class="btn-group" role="group">
            <button class="btn btn-outline-primary" id="showAllBtn">Tất cả khóa học</button>
            <button class="btn btn-outline-primary" id="showWatchlistBtn">Khóa yêu thích</button>
            <a href="/courses" class="btn btn-success">Thêm khóa học mới</a>
        </div>
    </div>

    <!-- Tab content -->
    {{!-- Display Enrolled Courses --}}
    <div id="allCourses">
        <div class="row mt-3 g-4"> {{!-- Added g-4 for spacing --}}
            {{#if courses.length}}
                {{#each courses}}
                <div class="col-md-6 col-lg-4 d-flex"> {{!-- Adjusted column classes --}}
                    <div class="card h-100 shadow-sm border-0">
                        {{!-- Use image_url from courses table --}}
                        <img src="{{this.image_url}}" class="card-img-top" alt="{{this.title}}" style="height: 180px; object-fit: cover;">
                        <div class="card-body d-flex flex-column"> {{!-- Use flex column --}}
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0 flex-grow-1 me-2">{{this.title}}</h5>
                                {{!-- Favorite button using API (requires separate JS or full page reload) --}}
                                {{!-- Consider simplifying or removing instant toggle here --}}
                                <button class="btn btn-link p-0 toggle-watchlist-enrolled" data-course-id="{{this.course_id}}"
                                        data-is-watchlisted="{{this.is_in_watchlist}}">
                                    <i class="bi {{#if this.is_in_watchlist}}bi-heart-fill text-danger{{else}}bi-heart text-secondary{{/if}}"
                                       style="font-size: 1.2rem;"></i>
                                </button>
                            </div>
                            {{!-- Progress Bar --}}
                            <div class="progress mb-3" style="height: 5px;">
                                <div class="progress-bar" role="progressbar" style="width: {{this.progress}}%;"
                                     aria-valuenow="{{this.progress}}" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            {{!-- Footer with Link and Date --}}
                            <div class="mt-auto d-flex justify-content-between align-items-center"> {{!-- mt-auto pushes to bottom --}}
                                <a href="/learn/{{this.course_id}}" class="btn btn-primary btn-sm">Vào học</a>
                                <small class="text-muted">Đã đăng ký: {{formatDate this.enrolled_at}}</small>
                            </div>
                        </div>
                    </div>
                </div>
                {{/each}}
            {{else}}
                <div class="col-12">
                    <p class="text-muted text-center mt-5">Bạn chưa đăng ký khóa học nào.</p>
                </div>
            {{/if}}
        </div>
    </div>

    <div id="watchlistCourses" style="display: none;">
        <div class="row mt-3">
            {{#each watchlistCourses}}
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <img src="{{this.thumbnail_url}}" class="card-img-top">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title mb-0">{{this.title}}</h5>
                            <button class="btn btn-link toggle-watchlist" data-course-id="{{this.course_id}}" data-is-watchlisted="true">
                                <i class="fas fa-heart" style="color: red;"></i>
                            </button>
                        </div>
                        <p class="card-text text-danger">{{formatPrice this.discount_price}} ₫ 
                            <span class="text-muted text-decoration-line-through">{{formatPrice this.price}} ₫</span>
                        </p>
                        <a href="/courses/{{this.course_id}}" class="btn btn-outline-primary">Xem chi tiết</a>
                    </div>
                </div>
            </div>
            {{/each}}
        </div>
    </div>
</div>

<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

{{#section "js"}}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Simplified Favorite Toggle for Enrolled Page (Requires Page Reload or more JS) ---
    // This version sends the request but doesn't instantly update UI beyond the icon
    document.querySelectorAll('.toggle-watchlist-enrolled').forEach(button => {
        button.addEventListener('click', async function() {
            const courseId = this.dataset.courseId;
            let isWatchlisted = this.dataset.isWatchlisted === 'true';
            const icon = this.querySelector('i');

            // Disable button during request
            this.disabled = true;
            icon.classList.add('opacity-50');

            try {
                const url = `/profile/watchlist/${isWatchlisted ? 'remove' : 'add'}/${courseId}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json' // Prefer JSON response
                    }
                });

                if (response.ok) {
                    // Toggle state and icon
                    isWatchlisted = !isWatchlisted;
                    this.dataset.isWatchlisted = isWatchlisted;
                    if (isWatchlisted) {
                        icon.classList.remove('bi-heart', 'text-secondary');
                        icon.classList.add('bi-heart-fill', 'text-danger');
                    } else {
                        icon.classList.remove('bi-heart-fill', 'text-danger');
                        icon.classList.add('bi-heart', 'text-secondary');
                    }
                     // Optional: Reload to see changes reflected if you have separate tabs/lists
                     // window.location.reload();
                } else {
                     console.error('Failed to update watchlist status:', response.status);
                     alert('Lỗi: Không thể cập nhật danh sách yêu thích.');
                }
            } catch (error) {
                console.error('Error toggling watchlist:', error);
                alert('Lỗi mạng khi cập nhật danh sách yêu thích.');
            } finally {
                // Re-enable button
                this.disabled = false;
                 icon.classList.remove('opacity-50');
            }
        });
    });
});
</script>
{{/section}}