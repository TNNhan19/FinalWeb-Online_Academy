<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Khoá học của tôi</h2>
        <div class="btn-group" role="group">
            <button class="btn btn-outline-primary" id="showAllBtn">Tất cả khóa học</button>
            <button class="btn btn-outline-primary" id="showWatchlistBtn">Khóa yêu thích</button>
            <a href="/#courses" class="btn btn-success">Thêm khóa học mới</a>
        </div>
    </div>

    <!-- Tab content -->
    {{!-- Display Enrolled Courses --}}
    <div id="allCourses">
        {{!-- Hiển thị danh sách nếu có khóa học --}}
        {{#if courses.length}}
    <div class="row mt-3 g-4">
      {{#each courses}}
        <div class="col-md-6 col-lg-4 d-flex">
          <div class="card h-100 shadow-sm border-0 w-100">

            {{!-- Ảnh: ưu tiên thumbnail_url, fallback image_url --}}
            <img
              src="{{#if this.thumbnail_url}}{{this.thumbnail_url}}{{else}}{{this.image_url}}{{/if}}"
              class="card-img-top"
              alt="{{this.title}}"
              style="height: 180px; object-fit: cover;"
            >

            <div class="card-body d-flex flex-column">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="card-title mb-0 me-2 flex-grow-1">{{this.title}}</h5>

                {{!-- Nút yêu thích (watchlist) --}}
                <button
                  class="btn btn-link p-0 toggle-watchlist"
                  data-course-id="{{this.course_id}}"
                  data-is-watchlisted="{{this.is_in_watchlist}}"
                  aria-label="Yêu thích"
                >
                  <i class="fas {{#if this.is_in_watchlist}}fa-heart text-danger{{else}}fa-heart{{/if}}"
                     style="{{#unless this.is_in_watchlist}}color: #6c757d;{{/unless}} font-size:1.1rem;"></i>
                </button>
              </div>

              {{!-- Meta --}}
              <p class="text-muted small mb-1">
                <i class="fas fa-user-tie me-1"></i> {{this.instructor_name}}
              </p>
              <p class="text-muted small mb-2">
                <i class="fas fa-folder me-1"></i> {{this.category_name}}
              </p>
              <p class="text-muted small mb-3">
                <i class="fas fa-book-open me-1"></i> {{this.total_lectures}} bài học
              </p>

              {{!-- Progress --}}
              <div class="progress mb-2" style="height: 6px;">
                <div class="progress-bar bg-success"
                     role="progressbar"
                     style="width: {{this.progress}}%;"
                     aria-valuenow="{{this.progress}}"
                     aria-valuemin="0"
                     aria-valuemax="100"></div>
              </div>
              <p class="small text-center text-muted mb-3">Hoàn thành: {{this.progress}}%</p>

              {{!-- Footer: nút vào học + ngày đăng ký --}}
              <div class="mt-auto d-flex justify-content-between align-items-center">
                <a href="/learn/{{this.course_id}}" class="btn btn-primary btn-sm">
                  <i class="fas fa-play-circle me-1"></i> Tiếp tục học
                </a>
                <small class="text-muted">Đăng ký: {{formatDate this.enrolled_at}}</small>
              </div>
            </div>
          </div>
        </div>
      {{/each}}
    </div>
    <div id="watchlistCourses" style="display: none;">
        {{#if watchlistCourses.length}}
        <div class="row mt-3">
            {{#each watchlistCourses}}
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <img src="{{this.thumbnail_url}}" class="card-img-top">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title mb-0">{{this.title}}</h5>
                            <button class="btn btn-link toggle-watchlist" data-course-id="{{this.course_id}}" data-is-watchlisted="true">
                                <i class="fas fa-heart" style="color: red;"></i>
                            </button>
                        </div>
                        <p class="card-text text-danger">{{formatPrice this.discount_price}} ₫ 
                            <span class="text-muted text-decoration-line-through">{{formatPrice this.price}} ₫</span>
                        </p>
                        <a href="/courses/{{this.course_id}}" class="btn btn-outline-primary">Xem chi tiết</a>
                    </div>
                </div>
            </div>
            {{/each}}
        </div>
        {{else}}
        <div class="text-center py-5">
            <div class="mb-3">
                <i class="fas fa-heart fa-4x text-muted"></i>
            </div>
            <h3 class="text-muted">Chưa có khóa học yêu thích</h3>
            <p class="text-muted mb-4">Hãy thêm các khóa học bạn quan tâm vào danh sách yêu thích</p>
            <a href="/#courses" class="btn btn-primary btn-lg">Tìm khóa học</a>
        </div>
        {{/if}}
    </div>
</div>

<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

{{#section "js"}}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Simplified Favorite Toggle for Enrolled Page (Requires Page Reload or more JS) ---
    // This version sends the request but doesn't instantly update UI beyond the icon
    document.querySelectorAll('.toggle-watchlist-enrolled').forEach(button => {
        button.addEventListener('click', async function() {
            const courseId = this.dataset.courseId;
            let isWatchlisted = this.dataset.isWatchlisted === 'true';
            const icon = this.querySelector('i');

            // Disable button during request
            this.disabled = true;
            icon.classList.add('opacity-50');

            try {
                const url = `/profile/watchlist/${isWatchlisted ? 'remove' : 'add'}/${courseId}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json' // Prefer JSON response
                    }
                });

                if (response.ok) {
                    // Toggle state and icon
                    isWatchlisted = !isWatchlisted;
                    this.dataset.isWatchlisted = isWatchlisted;
                    if (isWatchlisted) {
                        icon.classList.remove('bi-heart', 'text-secondary');
                        icon.classList.add('bi-heart-fill', 'text-danger');
                    } else {
                        icon.classList.remove('bi-heart-fill', 'text-danger');
                        icon.classList.add('bi-heart', 'text-secondary');
                    }
                     // Optional: Reload to see changes reflected if you have separate tabs/lists
                     // window.location.reload();
                } else {
                     console.error('Failed to update watchlist status:', response.status);
                     alert('Lỗi: Không thể cập nhật danh sách yêu thích.');
                }
            } catch (error) {
                console.error('Error toggling watchlist:', error);
                alert('Lỗi mạng khi cập nhật danh sách yêu thích.');
            } finally {
                // Re-enable button
                this.disabled = false;
                 icon.classList.remove('opacity-50');
            }
        });
    });
});
</script>
{{/section}}