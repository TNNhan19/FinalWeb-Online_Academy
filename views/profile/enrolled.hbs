<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Khoá học của tôi</h2>
        <div class="btn-group" role="group">
            <button class="btn btn-outline-primary" id="showAllBtn">Tất cả khóa học</button>
            <button class="btn btn-outline-primary" id="showWatchlistBtn">Khóa yêu thích</button>
            <a href="/courses" class="btn btn-success">Thêm khóa học mới</a>
        </div>
    </div>

    <!-- Tab content -->
    <div id="allCourses">
        <div class="row mt-3">
            {{#each courses}}
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <img src="{{this.thumbnail_url}}" class="card-img-top">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title mb-0">{{this.title}}</h5>
                            <button class="btn btn-link toggle-watchlist" data-course-id="{{this.course_id}}"
                                data-is-watchlisted="{{this.is_in_watchlist}}">
                                <i class="fas fa-heart{{#unless this.is_in_watchlist}}-o{{/unless}}"
                                    style="color: {{#if this.is_in_watchlist}}red{{else}}grey{{/if}};"></i>
                            </button>
                        </div>
                        <div class="progress mb-3">
                            <div class="progress-bar" role="progressbar" style="width: {{this.progress}}%;"
                                aria-valuenow="{{this.progress}}" aria-valuemin="0" aria-valuemax="100">
                                {{this.progress}}%
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="/courses/{{this.course_id}}" class="btn btn-primary">Vào học</a>
                            <small class="text-muted">Đã đăng ký: {{formatDate this.enrolled_at}}</small>
                        </div>
                    </div>
                </div>
            </div>
            {{/each}}
        </div>
    </div>

    <div id="watchlistCourses" style="display: none;">
        <div class="row mt-3">
            {{#each watchlistCourses}}
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <img src="{{this.thumbnail_url}}" class="card-img-top">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title mb-0">{{this.title}}</h5>
                            <button class="btn btn-link toggle-watchlist" data-course-id="{{this.course_id}}" data-is-watchlisted="true">
                                <i class="fas fa-heart" style="color: red;"></i>
                            </button>
                        </div>
                        <p class="card-text text-danger">{{formatPrice this.discount_price}} ₫ 
                            <span class="text-muted text-decoration-line-through">{{formatPrice this.price}} ₫</span>
                        </p>
                        <a href="/courses/{{this.course_id}}" class="btn btn-outline-primary">Xem chi tiết</a>
                    </div>
                </div>
            </div>
            {{/each}}
        </div>
    </div>
</div>

<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

<script>
document.addEventListener('DOMContentLoaded', function() {
    const allCoursesTab = document.getElementById('allCourses');
    const watchlistTab = document.getElementById('watchlistCourses');
    const allBtn = document.getElementById('showAllBtn');
    const watchlistBtn = document.getElementById('showWatchlistBtn');

    // Switch tabs
    allBtn.addEventListener('click', () => {
        allCoursesTab.style.display = 'block';
        watchlistTab.style.display = 'none';
        allBtn.classList.add('active');
        watchlistBtn.classList.remove('active');
    });

    watchlistBtn.addEventListener('click', () => {
        allCoursesTab.style.display = 'none';
        watchlistTab.style.display = 'block';
        watchlistBtn.classList.add('active');
        allBtn.classList.remove('active');
    });

    // Toggle watchlist
    document.querySelectorAll('.toggle-watchlist').forEach(button => {
        button.addEventListener('click', async function() {
            const courseId = this.dataset.courseId;
            const isWatchlisted = this.dataset.isWatchlisted === 'true';
            
            try {
                const response = await fetch(`/profile/watchlist/${isWatchlisted ? 'remove' : 'add'}/${courseId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    // Toggle heart icon
                    const icon = this.querySelector('i');
                    if (isWatchlisted) {
                        icon.classList.remove('fa-heart');
                        icon.classList.add('fa-heart-o');
                        icon.style.color = 'grey';
                        this.dataset.isWatchlisted = 'false';
                    } else {
                        icon.classList.remove('fa-heart-o');
                        icon.classList.add('fa-heart');
                        icon.style.color = 'red';
                        this.dataset.isWatchlisted = 'true';
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi cập nhật danh sách yêu thích');
            }
        });
    });
});
</script>