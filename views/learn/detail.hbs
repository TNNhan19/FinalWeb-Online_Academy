{{!-- views/learn/detail.hbs --}}

<div class="container my-4">

  {{!-- ======= VIDEO PLAYER SECTION ======= --}}
  <div class="video-player-container shadow-lg mb-4 rounded-3 overflow-hidden">
    <div id="plyr-root" class="position-relative w-100"></div>
    <div id="video-overlay-info"
      class="position-absolute bottom-0 start-0 text-white bg-dark bg-opacity-75 px-3 py-2 small rounded-top-end">
      {{#if courseData.sections.[0].lectures.[0]}}
      Đang xem: {{courseData.sections.[0].lectures.[0].title}}
      {{else}}
      Chưa có video bài giảng
      {{/if}}
    </div>
  </div>

  {{!-- ======= COURSE NAVIGATION TABS ======= --}}
  <ul class="nav nav-tabs mb-4 border-0 shadow-sm rounded-3 overflow-hidden bg-white">
    <li class="nav-item">
      <button class="nav-link active fw-semibold" id="tab-course" data-bs-toggle="tab"
        data-bs-target="#pane-course">Khóa học</button>
    </li>
    <li class="nav-item">
      <button class="nav-link fw-semibold" id="tab-members" data-bs-toggle="tab" data-bs-target="#pane-members">Thành
        viên</button>
    </li>
    <li class="nav-item">
      <button class="nav-link fw-semibold" id="tab-grade" data-bs-toggle="tab" data-bs-target="#pane-grade">Điểm
        số</button>
    </li>
  </ul>

  <div class="tab-content">
    {{!-- ==================== TAB 1: KHÓA HỌC ==================== --}}
    <div class="tab-pane fade show active" id="pane-course">

      {{!-- Accordion: Danh sách chương & bài học --}}
      <div class="accordion mb-4" id="courseAccordion">
        {{#each courseData.sections}}
        <div class="accordion-item shadow-sm mb-3 border-0 rounded-3">
          <h2 class="accordion-header">
            <button class="accordion-button fw-semibold bg-light" type="button" data-bs-toggle="collapse"
              data-bs-target="#collapse-{{section_id}}">
              {{order_index}}. {{title}} ({{lectures.length}} bài)
            </button>
          </h2>
          <div id="collapse-{{section_id}}" class="accordion-collapse collapse {{#if (eq order_index 1)}}show{{/if}}">
            <div class="accordion-body p-0">
              <ul class="list-group list-group-flush">
                {{#each lectures}}
                <li
                  class="list-group-item list-group-item-action lecture-link d-flex justify-content-between align-items-center"
                  data-video-url="{{video_url}}" data-lecture-title="{{title}}" style="cursor:pointer;">
                  <span class="text-truncate">
                    <i class="bi bi-play-circle me-2 text-secondary"></i>{{title}}
                  </span>
                  <small class="text-muted">{{formatDuration duration}}</small>
                </li>
                {{/each}}
              </ul>
            </div>
          </div>
        </div>
        {{else}}
        <div class="alert alert-info">Chưa có nội dung bài giảng.</div>
        {{/each}}
      </div>

      {{!-- Mô tả khóa học --}}
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
          <h5 class="fw-bold mb-3">Mô tả khóa học</h5>
          <p class="mb-0 text-secondary">{{courseData.course.description}}</p>
        </div>
      </div>

      {{!-- Form đánh giá --}}
      {{#if isEnrolled}}
      <div class="card shadow-sm border-0 mb-5">
        <div class="card-header bg-light fw-semibold">Viết đánh giá của bạn</div>
        <div class="card-body">
          <form action="/learn/{{courseData.course.course_id}}/review" method="POST">
            <div class="mb-3">
              <label class="form-label mb-1">Xếp hạng:</label>
              <div class="star-rating fs-4">
                <input type="radio" id="star5" name="rating" value="5"><label for="star5">★</label>
                <input type="radio" id="star4" name="rating" value="4"><label for="star4">★</label>
                <input type="radio" id="star3" name="rating" value="3"><label for="star3">★</label>
                <input type="radio" id="star2" name="rating" value="2"><label for="star2">★</label>
                <input type="radio" id="star1" name="rating" value="1" required><label for="star1">★</label>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Phản hồi:</label>
              <textarea class="form-control" name="feedback" rows="4" required
                placeholder="Chia sẻ trải nghiệm của bạn..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary px-4">Gửi đánh giá</button>
          </form>
        </div>
      </div>
      {{/if}}

    </div>

    {{!-- ==================== TAB 2: THÀNH VIÊN ==================== --}}
    <div class="tab-pane fade" id="pane-members">
      <div class="alert alert-light border shadow-sm">Tính năng này đang được phát triển.</div>
    </div>

    {{!-- ==================== TAB 3: ĐIỂM SỐ ==================== --}}
    <div class="tab-pane fade" id="pane-grade">
      <div class="alert alert-light border shadow-sm">Tính năng này đang được phát triển.</div>
    </div>
  </div>
</div>


{{!-- ==================== CUSTOM CSS ==================== --}}
{{#section 'css'}}
<style>
  /* Xóa khung đệm ảo tạo bởi ::before (chính là phần trống đen) */
  .video-player-container {
    max-width: 960px;
    margin: 0 auto;
    border-radius: 12px;
    background: #000;
    overflow: hidden;
    position: relative;
    padding: 0 !important;
    height: auto !important;
  }

  /* Fix triệt để khoảng đen ảo do Bootstrap ratio tạo ra */
  main .video-player-container::before,
  body .video-player-container::before {
    content: none !important;
    display: none !important;
    padding: 0 !important;
    height: 0 !important;
  }

  /* ✅ Fix chính: ghi đè khung giữ tỉ lệ 16:9 mặc định của Plyr */
  .video-player-container .plyr__video-wrapper {
    height: auto !important;
    aspect-ratio: auto !important;
  }

  /* Giữ player hiển thị đúng kích thước thực */
  #plyr-root {
    width: 100%;
    height: auto;
  }

  .plyr video,
  .plyr iframe {
    display: block;
    width: 100% !important;
    height: auto !important;
    background: #000 !important;
    object-fit: contain !important;
  }

  /* ====== Các phần khác không thay đổi ====== */
  .learn-layout {
    background-color: var(--bg-secondary);
    border-radius: 14px;
    padding: 24px;
  }

  .accordion-button:not(.collapsed) {
    color: var(--primary-color);
    background-color: rgba(37, 99, 235, 0.05);
  }

  .lecture-link:hover {
    background-color: rgba(37, 99, 235, 0.05);
  }

  .lecture-link.active {
    background-color: rgba(37, 99, 235, 0.1);
    border-left: 4px solid var(--primary-color);
  }

  #video-overlay-info {
    font-size: 0.9rem;
    border-top-right-radius: 8px;
  }

  .star-rating {
    direction: rtl;
    display: inline-flex;
  }

  .star-rating input {
    display: none;
  }

  .star-rating label {
    color: #ddd;
    cursor: pointer;
    transition: color 0.2s;
    font-size: 2rem;
  }

  .star-rating input:checked~label,
  .star-rating label:hover,
  .star-rating label:hover~label {
    color: #ffc107;
  }
</style>
{{/section}}

{{!-- ==================== PLYR + JS ==================== --}}
{{#section 'js'}}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3/dist/plyr.css" />
<script src="https://cdn.jsdelivr.net/npm/plyr@3/dist/plyr.polyfilled.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const root = document.getElementById('plyr-root');
    const titleEl = document.getElementById('video-overlay-info');
    const lectureLinks = document.querySelectorAll('.lecture-link');

    let player = null;
    let hls = null;

    const isYouTube = u => /youtu\.?be/.test(u || '');
    const isVimeo = u => /vimeo\.com/.test(u || '');
    const isHls = u => (u || '').includes('.m3u8');
    const isMP4 = u => /\.(mp4|webm|ogg)$/i.test(u || '');
    const toYouTubeId = u => (u || '').match(/(?:v=|youtu\.be\/)([\w-]{11})/)?.[1];
    const toVimeoId = u => (u || '').match(/vimeo\.com\/(\d+)/)?.[1];

    function mountPlayer(url) {
      if (player?.destroy) player.destroy();
      if (hls) { hls.destroy(); hls = null; }

      if (isYouTube(url)) {
        const id = toYouTubeId(url);
        root.innerHTML = `<div data-plyr-provider="youtube" data-plyr-embed-id="${id}"></div>`;
        player = new Plyr('[data-plyr-provider]');
      } else if (isVimeo(url)) {
        const id = toVimeoId(url);
        root.innerHTML = `<div data-plyr-provider="vimeo" data-plyr-embed-id="${id}"></div>`;
        player = new Plyr('[data-plyr-provider]');
      } else if (isHls(url)) {
        root.innerHTML = `<video class="plyr" controls playsinline></video>`;
        const video = root.querySelector('video');
        player = new Plyr(video);
        if (Hls.isSupported()) {
          hls = new Hls();
          hls.loadSource(url);
          hls.attachMedia(video);
        } else video.src = url;
      }
      else if (isMP4(url)) {
        root.innerHTML = `<video class="plyr" controls playsinline>
                      <source src="${url}" type="video/mp4">
                    </video>`;

        const video = root.querySelector('video');
        player = new Plyr(video, {
          controls: [
            'play-large',     // Nút play to ở giữa
            'rewind',         // Tua lại 10s
            'play',           // Play/pause nhỏ
            'fast-forward',   // Tua tới 10s
            'progress',       // Thanh tiến độ
            'current-time',   // Thời gian hiện tại
            'duration',       // Tổng thời lượng
            'mute',           // Nút tắt tiếng
            'volume',         // Thanh chỉnh âm lượng
            'captions',       // Phụ đề (nếu có)
            'settings',       // Menu settings (tốc độ, subtitle,…)
            'pip',            // Picture-in-Picture
            'airplay',        // AirPlay (nếu có)
            'fullscreen'      // Toàn màn hình
          ],
          seekTime: 10,
          clickToPlay: true,
          keyboard: { focused: true, global: true },
        });
      }

      else {
        root.innerHTML = `<div class="text-white p-4 bg-dark">Không thể phát video.</div>`;
      }
    }

    lectureLinks.forEach(li => {
      li.addEventListener('click', () => {
        lectureLinks.forEach(x => x.classList.remove('active'));
        li.classList.add('active');
        const url = li.dataset.videoUrl;
        const title = li.dataset.lectureTitle;
        mountPlayer(url);
        titleEl.textContent = `Đang xem: ${title}`;
      });
    });

    const first = document.querySelector('.lecture-link');
    if (first) {
      first.classList.add('active');
      mountPlayer(first.dataset.videoUrl);
    }
  });
</script>
{{/section}}