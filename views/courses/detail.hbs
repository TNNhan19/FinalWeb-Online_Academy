<hr class="my-4">
<h5>üë®‚Äçüè´ Gi·∫£ng vi√™n</h5>
<div class="mt-3">
  <h6 class="fw-semibold">{{instructor.name}}</h6>
  <p class="text-muted mb-1">üë• {{instructor.total_students}} h·ªçc vi√™n</p>
  <p>{{instructor.bio}}</p>
</div>

<div class="container py-4">
  <div class="row g-lg-5">

    {{!-- --- Left Column: Course Content --- --}}
    <div class="col-lg-8">

      {{!-- Breadcrumb & Main Info --}}
      <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb small bg-light p-2 rounded-pill">
          <li class="breadcrumb-item"><a href="/" class="text-decoration-none">Trang ch·ªß</a></li>
          <li class="breadcrumb-item"><a href="/courses?category={{course.category_id}}" class="text-decoration-none">{{course.category_name}}</a></li>
          <li class="breadcrumb-item active" aria-current="page">{{course.title}}</li>
        </ol>
      </nav>

      {{!-- Course Title & Short Description --}}
      <h1 class="h2 fw-bold mb-2">{{course.title}}</h1>
      <p class="lead text-muted mb-3">{{course.description}}</p>

      {{!-- Meta Bar (Rating, Enrollment, Instructor, etc.) --}}
      <div class="d-flex flex-wrap align-items-center gap-3 small text-muted mb-4">
        {{#if course.is_bestseller}}
          <span class="badge bg-warning text-dark">Bestseller</span>
        {{/if}}
        <div>
          <span class="text-warning me-1">
            <i class="bi bi-star-fill"></i> {{course.average_rating}}
          </span>
          <span class="fw-semibold">({{course.total_reviews}} ƒë√°nh gi√°)</span>
        </div>
        <span><i class="bi bi-people-fill"></i> {{course.enrollment_count}} h·ªçc vi√™n</span>
        <span>T·∫°o b·ªüi <a href="#instructor" class="text-decoration-none">{{course.instructor_name}}</a></span>
        <span><i class="bi bi-calendar-check"></i> C·∫≠p nh·∫≠t: {{formatDate course.created_at}}</span>
        <span><i class="bi bi-bar-chart-fill"></i> {{course.level}}</span>
      </div>

      {{!-- Large Image --}}
      <img src="{{course.image_url}}" alt="{{course.title}}" class="img-fluid rounded-3 mb-4 shadow-sm" style="max-height: 450px; width: 100%; object-fit: cover;">


      {{!-- Image Gallery (Optional) --}}
      {{#if galleryImages.length}}
      <div class="mb-4">
          <h5 class="fw-semibold mb-3">H√¨nh ·∫£nh kh√°c</h5>
          <div class="row g-2 row-cols-2 row-cols-md-3 row-cols-lg-4">
              {{#each galleryImages}}
                  <div class="col">
                      <a href="{{this.image_url}}" target="_blank">
                      <img src="{{this.image_url}}" alt="{{this.description}}" class="img-fluid rounded shadow-sm" style="height: 120px; width: 100%; object-fit: cover;">
                      </a>
                  </div>
              {{/each}}
          </div>
      </div>
      {{/if}}

      {{!-- Detailed Description (Currently commented out in original file) --}}
      {{!-- <div class="card card-body border-0 bg-light mb-4 p-4">
        <h5 class="fw-semibold mb-3">B·∫°n s·∫Ω h·ªçc ƒë∆∞·ª£c g√¨?</h5>
        {{{course.detail_html}}}
      </div> --}}

      {{!-- Course Outline (Sections & Lectures) --}}
      <h4 class="fw-bold mb-3">N·ªôi dung kh√≥a h·ªçc</h4>
      <div class="text-muted small mb-3">
        {{sections.length}} ch∆∞∆°ng ‚Ä¢ {{course.total_lectures}} b√†i h·ªçc ‚Ä¢ {{course.total_hours}} gi·ªù t·ªïng th·ªùi l∆∞·ª£ng
      </div>
      <div class="accordion accordion-flush border rounded-3 mb-4 shadow-sm" id="courseAccordion">
        {{#each sections}}
        <div class="accordion-item">
          <h2 class="accordion-header" id="heading-{{section_id}}">
            <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{section_id}}">
              Ch∆∞∆°ng {{order_index}}: {{title}}
              <span class="ms-auto small text-muted me-3">{{lectures.length}} b√†i</span>
            </button>
          </h2>
          <div id="collapse-{{section_id}}" class="accordion-collapse collapse" data-bs-parent="#courseAccordion">
            <div class="accordion-body p-0">
              <ul class="list-group list-group-flush">
                {{#each lectures}}
                <li class="list-group-item d-flex justify-content-between align-items-center py-2 px-3">
                  <div class="text-truncate me-3">
                    <i class="bi bi-play-circle me-2 text-secondary"></i>
                    <span>{{title}}</span>
                  </div>
                  <div class="text-nowrap">
                    {{#if is_preview}}
                      {{!-- Allow preview for everyone --}}
                      <a href="{{video_url}}" target="_blank" class="badge text-bg-primary text-decoration-none me-2">Xem th·ª≠</a>
                      <span class="small text-muted">({{formatDuration duration}})</span>
                    {{else}}
                      {{!-- Not previewable, show lock/duration based on login --}}
                      {{#if @root.user}} {{!-- Check if user is logged in --}}
                        <span class="small text-muted">({{formatDuration duration}})</span>
                      {{else}}
                         <i class="bi bi-lock-fill text-muted me-2" title="C·∫ßn ƒëƒÉng nh·∫≠p/mua kh√≥a h·ªçc"></i>
                         <span class="small text-muted">({{formatDuration duration}})</span>
                      {{/if}}
                    {{/if}}
                  </div>
                </li>
                {{/each}}
              </ul>
            </div>
          </div>
        </div>
        {{else}}
         <div class="p-3 text-muted">N·ªôi dung kh√≥a h·ªçc ƒëang ƒë∆∞·ª£c c·∫≠p nh·∫≠t.</div>
        {{/each}}
      </div>

      {{!-- Instructor Info --}}
      <h4 class="fw-bold mb-3" id="instructor">Th√¥ng tin gi·∫£ng vi√™n</h4>
      <div class="mb-4 p-3 bg-light rounded-3">
        <h5 class="fw-semibold text-primary mb-1">{{course.instructor_name}}</h5>
        {{!-- <p class="small text-muted mb-2">Ch·ª©c danh gi·∫£ng vi√™n (n·∫øu c√≥)</p> --}}
        <div class="d-flex align-items-center gap-3 small mb-2">
           <img src="https://placehold.co/60x60/7F8C8D/FFFFFF&text={{firstLetter course.instructor_name}}" class="rounded-circle" alt="{{course.instructor_name}}">
           <div class="vstack">
             {{!-- Placeholder stats - fetch real ones if needed --}}
             <div><i class="bi bi-star-fill text-warning me-1"></i> 4.7 ƒê√°nh gi√° gi·∫£ng vi√™n</div>
             <div><i class="bi bi-people-fill text-success me-1"></i> {{course.instructor_total_students}} H·ªçc vi√™n</div>
             {{!-- <div><i class="bi bi-collection-play-fill text-danger me-1"></i> X Kh√≥a h·ªçc</div> --}}
           </div>
        </div>
        <p class="text-muted small">{{course.instructor_bio}}</p>
      </div>

      {{!-- Student Feedback / Reviews --}}
      <h4 class="fw-bold mb-3">ƒê√°nh gi√° c·ªßa h·ªçc vi√™n</h4>
       <div class="d-flex align-items-baseline mb-3 p-3 bg-light rounded-3">
           <span class="display-4 fw-bold text-warning me-3">{{course.average_rating}}</span>
           <div class="lh-1">
             <div class="text-warning"> {{!-- Render Stars --}}
                {{#each (stars course.average_rating)}}
                     <i class="bi {{this}}"></i>
                {{/each}}
             </div>
             <div class="small text-muted">ƒê√°nh gi√° trung b√¨nh ({{course.total_reviews}} l∆∞·ª£t)</div>
           </div>
       </div>

      <div>
        {{#each reviews}}
         <div class="border-top py-3">
          <div class="d-flex align-items-start gap-3">
             <img src="https://placehold.co/40x40/7F8C8D/FFFFFF&text={{firstLetter student_name}}" class="rounded-circle mt-1" alt="{{student_name}}">
            <div class="w-100">
              <div class="d-flex justify-content-between align-items-center mb-1">
                 <span class="fw-semibold">{{student_name}}</span>
                 <span class="small text-muted">{{formatDate created_at}}</span>
              </div>
              <div class="small text-warning mb-1">
                 {{#each (stars rating)}}
                    <i class="bi {{this}}"></i>
                {{/each}}
              </div>
              <p class="mb-0 small">{{feedback}}</p>
            </div>
          </div>
        </div>
        {{else}}
        <p class="text-muted">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</p>
        {{/each}}
      </div>

    </div> {{!-- End Left Column --}}

    {{!-- --- Right Column: Purchase Box & Related Courses --- --}}
    <div class="col-lg-4">
      <div class="sticky-top" style="top: 80px;">

        {{!-- Purchase Card --}}
        <div class="card shadow border-0 mb-4 overflow-hidden">
          {{!-- Video Preview Placeholder --}}
          <div class="ratio ratio-16x9">
              <iframe src="https://www.youtube.com/embed/xBrD8dgfvBg?si=tUHdDxh7lD3a7q4g" title="Mock video preview" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
          </div>
          <div class="card-body p-3">
            {{!-- Price Display --}}
            <div class="mb-3">
              {{#if (isDiscount course.current_price course.original_price)}}
                 <span class="h2 fw-bold me-2">${{course.current_price}}</span>
                <span class="text-decoration-line-through text-muted">${{course.original_price}}</span>
                <span class="badge bg-danger ms-2">{{discountPercent course.current_price course.original_price}}% OFF</span>
              {{else}}
                <span class="h2 fw-bold">${{course.original_price}}</span>
              {{/if}}
            </div>

            {{!-- Action Buttons (Buy, Add to Cart, Favorite) --}}
            <div class="d-grid gap-2 mb-3">
               {{#if user}}
                  {{!-- TODO: Add logic to check enrollment status and display appropriately --}}
                 {{!-- <button class="btn btn-success btn-lg disabled">ƒê√£ ƒëƒÉng k√Ω</button> --}}
                 <button class="btn btn-danger btn-lg">Th√™m v√†o gi·ªè h√†ng</button>
                 <button class="btn btn-outline-dark">Mua ngay</button>
               {{else}}
                 <a href="/auth/login?redirect=/courses/{{course.course_id}}" class="btn btn-danger btn-lg">ƒêƒÉng nh·∫≠p ƒë·ªÉ mua</a>
               {{/if}}

               {{!-- Favorite Button Section --}}
               <div id="favorite-button-container">
                  {{#if isFavorite}}
                    <form action="/courses/{{course.course_id}}/unfavorite" method="POST" id="unfavorite-form">
                      <button type="submit" class="btn btn-outline-danger w-100"> {{!-- Added w-100 for consistency --}}
                          <i class="bi bi-heart-fill me-1"></i> B·ªè y√™u th√≠ch
                      </button>
                    </form>
                  {{else}}
                    <form action="/courses/{{course.course_id}}/favorite" method="POST" id="favorite-form">
                      <button type="submit" class="btn btn-outline-secondary w-100"> {{!-- Changed to secondary, Added w-100 --}}
                          <i class="bi bi-heart me-1"></i> Th√™m v√†o y√™u th√≠ch
                      </button>
                    </form>
                  {{/if}}
               </div>
            </div>
            <p class="small text-center text-muted mb-3">ƒê·∫£m b·∫£o ho√†n ti·ªÅn trong 30 ng√†y</p>

            {{!-- Course Includes List --}}
            <h6 class="fw-semibold small">Kh√≥a h·ªçc n√†y bao g·ªìm:</h6>
            <ul class="list-unstyled small text-muted mb-0">
              <li class="mb-1"><i class="bi bi-camera-video me-2 text-primary"></i> {{course.total_hours}} gi·ªù video theo y√™u c·∫ßu</li>
              <li class="mb-1"><i class="bi bi-journal-text me-2 text-primary"></i> {{course.total_lectures}} b√†i h·ªçc</li>
              {{!-- Add more items like articles, downloadable resources if available in DB --}}
              <li class="mb-1"><i class="bi bi-phone me-2 text-primary"></i> Truy c·∫≠p tr√™n di ƒë·ªông v√† TV</li>
              <li class="mb-1"><i class="bi bi-infinity me-2 text-primary"></i> Truy c·∫≠p tr·ªçn ƒë·ªùi</li>
              <li class="mb-1"><i class="bi bi-patch-check me-2 text-primary"></i> Ch·ª©ng ch·ªâ ho√†n th√†nh</li>
            </ul>
             {{!-- Optional Share/Gift buttons (commented out in original) --}}
             {{!-- <div class="d-flex justify-content-center gap-2 mt-3">
                <button class="btn btn-sm btn-outline-secondary">Chia s·∫ª</button>
                <button class="btn btn-sm btn-outline-secondary">T·∫∑ng kh√≥a h·ªçc</button>
             </div> --}}
          </div>
        </div>

        {{!-- Related Courses Card --}}
        {{#if relatedCourses.length}}
        <div class="card shadow-sm border-0">
          <div class="card-header bg-light fw-semibold">Kh√≥a h·ªçc li√™n quan</div>
          <div class="list-group list-group-flush">
            {{#each relatedCourses}}
             <a href="/courses/{{course_id}}" class="list-group-item list-group-item-action d-flex align-items-center gap-3 py-2">
               <img src="{{image_url}}" class="rounded" width="50" height="50" alt="{{title}}" style="object-fit: cover;">
                <div class="flex-fill overflow-hidden">
                  <div class="small fw-semibold text-truncate">{{title}}</div>
                  <div class="xsmall text-muted text-truncate">{{instructor_name}}</div>
                   <div class="xsmall text-warning"><i class="bi bi-star-fill me-1"></i>{{average_rating}}</div>
                 </div>
                 <div class="fw-bold small ms-auto">${{current_price}}</div>
              </a>
            {{/each}}
          </div>
        </div>
        {{/if}}

      </div> {{!-- End Sticky Top --}}
    </div> {{!-- End Right Column --}}

  </div> {{!-- End Row --}}
</div> {{!-- End Container --}}

{{!-- Section for JavaScript --}}
{{#section "js"}}
  {{!-- Helpers for stars (if needed) --}}
  {{!-- ... --}}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    console.log("‚úÖ Detail page JS loaded."); // Check if script runs

    const favoriteContainer = document.getElementById('favorite-button-container');

    // Ensure the container exists before adding listener
    if (favoriteContainer) {
      console.log("‚úÖ Favorite container (#favorite-button-container) found.");

      // --- Get courseId (no changes needed here) ---
      const initialForm = favoriteContainer.querySelector('form');
      let courseId = null;
      if (initialForm && initialForm.action) {
         const actionParts = initialForm.action.split('/');
         if (actionParts.length >= 3) { courseId = actionParts[actionParts.length - 2]; }
      }
      if (!courseId) {
           console.error("‚ùå ERROR: Could not extract course ID from form action.");
           courseId = '{{course.course_id}}'; // Fallback
           if (!courseId || courseId === 'undefined' || courseId === '') {
                console.error("‚ùå ERROR: Fallback course ID is also invalid."); return;
           }
           console.warn("‚ö†Ô∏è Falling back to Handlebars variable for course ID:", courseId);
      }
      console.log("‚û°Ô∏è Course ID for favorite logic:", courseId);
      // --- End courseId extraction ---


      // Function to update button appearance instantly
      const updateButtonAppearance = (isNowFavorite) => {
        console.log("üîÑ Updating button appearance. Is now favorite:", isNowFavorite);
        // Add a temporary disabled state while processing
        favoriteContainer.style.opacity = '0.5';
        favoriteContainer.style.pointerEvents = 'none';

        if (isNowFavorite) {
          // Replace with unfavorite form
          favoriteContainer.innerHTML = `
            <form action="/courses/${courseId}/unfavorite" method="POST" id="unfavorite-form">
              <button type="submit" class="btn btn-outline-danger w-100">
                  <i class="bi bi-heart-fill me-1"></i> B·ªè y√™u th√≠ch
              </button>
            </form>
          `;
        } else {
          // Replace with favorite form
          favoriteContainer.innerHTML = `
            <form action="/courses/${courseId}/favorite" method="POST" id="favorite-form">
              <button type="submit" class="btn btn-outline-secondary w-100">
                  <i class="bi bi-heart me-1"></i> Th√™m v√†o y√™u th√≠ch
              </button>
            </form>
          `;
        }
        console.log("‚úÖ Button HTML updated.");
        // Re-enable after a short delay to prevent rapid clicking issues
        setTimeout(() => {
            favoriteContainer.style.opacity = '1';
            favoriteContainer.style.pointerEvents = 'auto';
        }, 300); // 300ms delay
      };

      // Use event delegation on the container for form submissions
      favoriteContainer.addEventListener('submit', async (event) => {
         // --- PREVENT THE DEFAULT FORM SUBMISSION ---
         event.preventDefault();
         // Make sure the event target is one of our forms
         if (event.target.matches('#favorite-form, #unfavorite-form')) {
              const form = event.target;
              const url = form.action; // Get URL from the form that was clicked
              const method = form.method.toUpperCase(); // Get method (POST)

              let isAddingFavorite = (form.id === 'favorite-form');
              // --- MANUALLY SEND REQUEST USING FETCH ---
              try {
                  const response = await fetch(url, {
                      method: method,
                      headers: {
                          'Content-Type': 'application/json' // Adjust if needed
                      },
                  });
                  if (response.ok) {
                      console.log(`‚úÖ Request to ${url} successful.`);
                      updateButtonAppearance(isAddingFavorite);

                  } else {
                      // Handle server errors (e.g., 403 Forbidden, 500 Internal Server Error)
                      console.error(`‚ùå Request to ${url} failed with status ${response.status}.`);
                      alert(`L·ªói ${response.status}: Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t danh s√°ch y√™u th√≠ch. Vui l√≤ng th·ª≠ l·∫°i.`);
                  }
              } catch (error) {
                  // Handle network errors (fetch failed to send)
                  console.error(`‚ùå Network error during fetch to ${url}:`, error);
                  alert("L·ªói m·∫°ng: Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi v√† th·ª≠ l·∫°i.");
              }
          } 
      });
    }
  });
</script>
{{/section}}