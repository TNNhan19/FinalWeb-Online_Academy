<a href="/admin/users" class="btn btn-outline-secondary mb-4">
    ‚¨ÖÔ∏è Quay l·∫°i danh s√°ch ng∆∞·ªùi d√πng
</a>

<h4 class="fw-bold text-center mb-4">H·ªì s∆° ng∆∞·ªùi d√πng ({{role}})</h4>

<!-- üß© KHUNG TH√îNG TIN CHUNG -->
<div class="card shadow-sm border-0 p-4 mx-auto mb-5" style="max-width: 800px; border-radius: 12px;">
    <form method="POST"
        action="/admin/users/update/{{role}}/{{#if profile.instructor_id}}{{profile.instructor_id}}{{else}}{{profile.account_id}}{{/if}}">
        <div class="row g-4">
            <div class="col-md-6">
                <label class="form-label fw-semibold">H·ªç v√† t√™n</label>
                <input type="text" name="full_name" class="form-control" value="{{profile.full_name}}" required>
            </div>
            <div class="col-md-6">
                <label class="form-label fw-semibold">Email</label>
                <input type="email" name="email" class="form-control" value="{{profile.email}}" required>
            </div>
        </div>

        {{#if (eq role "instructor")}}
        <div class="mt-4">
            <label class="form-label fw-semibold">Gi·ªõi thi·ªáu b·∫£n th√¢n</label>
            <textarea name="bio" class="form-control" rows="4">{{profile.bio}}</textarea>
        </div>
        <div class="mt-3">
            <label class="form-label fw-semibold">T·ªïng h·ªçc vi√™n</label>
            <input type="number" name="total_students" class="form-control" value="{{profile.total_students}}">
        </div>
        {{/if}}

        {{#if (eq role "admin")}}
        <div class="mt-4">
            <p><strong>Vai tr√≤:</strong> {{profile.role}}</p>
            <p><strong>Ng√†y t·∫°o:</strong> {{profile.created_at}}</p>
        </div>
        {{/if}}

        {{#if (eq role "student")}}
        <div class="mt-4">
            <p><strong>Vai tr√≤:</strong> {{profile.role}}</p>
            <p><strong>Ng√†y t·∫°o:</strong> {{profile.created_at}}</p>
        </div>
        {{/if}}

        <div class="text-end mt-4">
            <button type="submit" class="btn btn-primary px-4 fw-semibold">üíæ L∆∞u thay ƒë·ªïi</button>
        </div>
    </form>
</div>

{{!-- ======================================================= --}}
{{!-- üìò DANH S√ÅCH KH√ìA H·ªåC C·ª¶A GI·∫¢NG VI√äN --}}
{{!-- ======================================================= --}}
{{#if (eq role "instructor")}}
<hr class="my-5">

<div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="fw-bold mb-0">üìö Danh s√°ch kh√≥a h·ªçc c·ªßa gi·∫£ng vi√™n</h5>
    <button class="btn btn-success btn-sm fw-semibold" data-bs-toggle="modal" data-bs-target="#addCourseModal">
        ‚ûï Th√™m kh√≥a h·ªçc m·ªõi
    </button>
</div>

{{#if profile.courses.length}}
<div class="table-responsive">
    <table class="table table-hover align-middle border shadow-sm" id="coursesTable">
        <thead class="table-primary">
            <tr class="text-center">
                <th>ID</th>
                <th>Ti√™u ƒë·ªÅ</th>
                <th>Tr·∫°ng th√°i</th>
                <th>B√†i gi·∫£ng</th>
                <th>Gi·ªù h·ªçc</th>
                <th>Gi√° ($)</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody>
            {{#each profile.courses}}
            <tr data-course-id="{{course_id}}">
                <td class="text-center fw-semibold text-secondary">{{course_id}}</td>
                <td>{{title}}</td>
                <td class="text-center">
                    {{#if (eq status "complete")}}
                    <span class="badge bg-success">Ho√†n th√†nh</span>
                    {{else}}
                    <span class="badge bg-warning text-dark">Ch∆∞a ho√†n th√†nh</span>
                    {{/if}}
                </td>
                <td class="text-center">{{total_lectures}}</td>
                <td class="text-center">{{total_hours}}</td>
                <td class="text-center fw-semibold text-success">{{current_price}}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-danger delete-course-btn">üóë X√≥a</button>
                </td>
            </tr>
            {{/each}}
        </tbody>
    </table>
</div>
{{else}}
<p class="text-center text-muted">Gi·∫£ng vi√™n n√†y ch∆∞a ƒëƒÉng b·∫•t k·ª≥ kh√≥a h·ªçc n√†o.</p>
{{/if}}

<!-- üß© MODAL: ƒêƒÇNG KH√ìA H·ªåC M·ªöI (B·ªê C·ª§C D·ªåC) -->
<div class="modal fade" id="addCourseModal" tabindex="-1" aria-labelledby="addCourseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold" id="addCourseModalLabel">üìò ƒêƒÉng kh√≥a h·ªçc m·ªõi</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body bg-light p-4">
                <form id="addCourseForm" enctype="multipart/form-data" class="needs-validation" novalidate>
                    <input type="hidden" name="instructor_id" value="{{profile.instructor_id}}">

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Ti√™u ƒë·ªÅ kh√≥a h·ªçc</label>
                        <input type="text" name="title" class="form-control form-control-lg"
                            placeholder="Nh·∫≠p ti√™u ƒë·ªÅ kh√≥a h·ªçc" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">M√¥ t·∫£ ng·∫Øn</label>
                        <textarea name="description" class="form-control form-control-lg" rows="3"
                            placeholder="T√≥m t·∫Øt ng·∫Øn g·ªçn v·ªÅ kh√≥a h·ªçc" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">N·ªôi dung chi ti·∫øt</label>
                        <textarea name="detail_html" class="form-control form-control-lg" rows="7"
                            placeholder="Nh·∫≠p n·ªôi dung chi ti·∫øt cho kh√≥a h·ªçc..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Danh m·ª•c</label>
                        <select name="category_id" class="form-select form-select-lg" required>
                            <option value="">-- Ch·ªçn lƒ©nh v·ª±c --</option>
                            {{#each categories}}
                            <option value="{{category_id}}">{{name}}</option>
                            {{/each}}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">·∫¢nh ƒë·∫°i di·ªán kh√≥a h·ªçc</label>
                        <input type="file" name="image" class="form-control form-control-lg" accept="image/*" required>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">T·ªïng th·ªùi l∆∞·ª£ng (gi·ªù)</label>
                            <input type="number" name="total_hours" class="form-control" min="0" step="0.1">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">T·ªïng s·ªë b√†i gi·∫£ng</label>
                            <input type="number" name="total_lectures" class="form-control" min="0">
                        </div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Gi√° g·ªëc ($)</label>
                            <input type="number" name="original_price" class="form-control" min="0" step="0.01">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Gi√° khuy·∫øn m√£i ($)</label>
                            <input type="number" name="current_price" class="form-control" min="0" step="0.01">
                        </div>
                    </div>

                    <div class="text-end">
                        <button type="submit" class="btn btn-primary px-5 py-2 fw-semibold">
                            üíæ L∆∞u kh√≥a h·ªçc
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    #addCourseModal .modal-dialog {
        max-width: 700px !important;
    }

    #addCourseModal .modal-content {
        border-radius: 16px;
    }

    #addCourseModal input,
    #addCourseModal textarea,
    #addCourseModal select {
        border-radius: 10px;
    }

    #addCourseModal .form-label {
        color: #1e293b;
    }
</style>

<script>
    document.getElementById("addCourseForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const res = await fetch(`/admin/users/add-course/${formData.get("instructor_id")}`, {
            method: "POST",
            body: formData
        });
        const result = await res.json();
        if (res.ok) {
            alert("‚úÖ Kh√≥a h·ªçc ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng!");
            location.reload();
        } else {
            alert(result.error || "‚ùå L·ªói khi th√™m kh√≥a h·ªçc.");
        }
    });


    // üóë X√ìA KH√ìA H·ªåC
    document.addEventListener("click", async (e) => {
        if (e.target.classList.contains("delete-course-btn")) {
            const row = e.target.closest("tr");
            const courseId = row.getAttribute("data-course-id");
            if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a kh√≥a h·ªçc n√†y?")) return;
            const res = await fetch(`/admin/users/delete-course/${courseId}`, { method: "DELETE" });
            if (res.ok) row.remove();
            else alert("Kh√¥ng th·ªÉ x√≥a kh√≥a h·ªçc. Vui l√≤ng th·ª≠ l·∫°i.");
        }
    });
</script>
{{/if}}