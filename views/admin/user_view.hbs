<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<a href="/admin/users" class="btn-back mb-4 d-inline-flex align-items-center gap-2">
    <i class="bi bi-arrow-left"></i> Quay lại danh sách người dùng
</a>

<h4 class="fw-bold text-center mb-4 d-flex justify-content-center align-items-center"
    style="color: var(--primary-color);">
    <i class="bi bi-person-badge me-2"></i> Hồ sơ người dùng
    <span class="badge bg-info text-dark ms-2 text-capitalize">{{role}}</span>
</h4>

<div class="card shadow-sm border-0 p-5 mx-auto mb-5 profile-card" style="max-width: 960px; border-radius: 16px;">
    <form class="user-profile-form" method="POST"
        action="/admin/users/update/{{role}}/{{#if profile.instructor_id}}{{profile.instructor_id}}{{else}}{{profile.account_id}}{{/if}}">
        <div class="row g-5">
            <div class="col-md-6">
                <label class="form-label fw-semibold mb-2">Họ và tên</label>
                <input type="text" name="full_name" class="form-control form-control-lg" value="{{profile.full_name}}"
                    required>
            </div>
            <div class="col-md-6">
                <label class="form-label fw-semibold mb-2">Email</label>
                <input type="email" name="email" class="form-control form-control-lg" value="{{profile.email}}"
                    required>
            </div>
        </div>

        {{#if (eq role "instructor")}}
        <div class="mt-4">
            <label class="form-label fw-semibold mb-2">Giới thiệu bản thân</label>
            <textarea name="bio" class="form-control form-control-lg" rows="4">{{profile.bio}}</textarea>
        </div>
        <div class="mt-4">
            <label class="form-label fw-semibold mb-2">Tổng học viên</label>
            <input type="number" name="total_students" class="form-control form-control-lg"
                value="{{profile.total_students}}">
        </div>
        {{/if}}

        {{#if (eq role "admin")}}
        <div class="row g-5 mt-1">
            <div class="col-md-6">
                <div class="p-3 rounded-3 bg-light">Vai trò: <strong>{{profile.role}}</strong></div>
            </div>
            <div class="col-md-6">
                <div class="p-3 rounded-3 bg-light">Ngày tạo: <strong>{{profile.created_at}}</strong></div>
            </div>
        </div>
        {{/if}}

        {{#if (eq role "student")}}
        <div class="row g-5 mt-1">
            <div class="col-md-6">
                <div class="p-3 rounded-3 bg-light">Vai trò: <strong>{{profile.role}}</strong></div>
            </div>
            <div class="col-md-6">
                <div class="p-3 rounded-3 bg-light">Ngày tạo: <strong>{{profile.created_at}}</strong></div>
            </div>
        </div>
        {{/if}}

        <div class="text-end mt-4">
            <button type="submit"
                class="btn-gradient btn-green px-4 fw-semibold d-inline-flex align-items-center gap-2">
                <i class="bi bi-save2"></i> Lưu thay đổi
            </button>
        </div>
    </form>
</div>


{{#if (eq role "instructor")}}
<hr class="my-5">

<div class="course-header d-flex justify-content-between align-items-center p-3 px-4 mb-4">
  <h5 class="fw-bold mb-0 d-flex align-items-center gap-2 text-primary">
    <i class="bi bi-journal-text fs-4"></i> Danh sách khóa học của giảng viên
  </h5>
  <button class="btn-gradient btn-blue fw-semibold d-inline-flex align-items-center gap-2 px-4 py-2"
          data-bs-toggle="modal" data-bs-target="#addCourseModal">
    <i class="bi bi-plus-circle"></i> Thêm khóa học mới
  </button>
</div>


{{#if profile.courses.length}}
<div class="table-responsive shadow-sm rounded-3">
    <table class="table table-hover table-bordered align-middle mb-0" id="coursesTable">
        <thead class="table-light">
            <tr class="text-center">
                <th style="width:6rem;">ID</th>
                <th>Tiêu đề</th>
                <th style="width:10rem;">Trạng thái</th>
                <th style="width:8rem;">Bài giảng</th>
                <th style="width:8rem;">Giờ học</th>
                <th style="width:9rem;">Giá ($)</th>
                <th style="width:9rem;">Hành động</th>
            </tr>
        </thead>
        <tbody>
            {{#each profile.courses}}
            <tr data-course-id="{{course_id}}">
                <td class="text-center fw-semibold text-secondary">{{course_id}}</td>
                <td class="fw-medium">{{title}}</td>
                <td class="text-center">
                    {{#if (eq status "complete")}}
                    <span class="badge bg-success">Hoàn thành</span>
                    {{else}}
                    <span class="badge bg-warning text-dark">Chưa hoàn thành</span>
                    {{/if}}
                </td>
                <td class="text-center">{{total_lectures}}</td>
                <td class="text-center">{{total_hours}}</td>
                <td class="text-center fw-semibold text-primary">{{current_price}}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-danger btn-compact delete-course-btn">
                        <i class="bi bi-trash"></i> Xóa
                    </button>
                </td>
            </tr>
            {{/each}}
        </tbody>
    </table>
</div>
{{else}}
<p class="text-center text-muted">Giảng viên này chưa đăng bất kỳ khóa học nào.</p>
{{/if}}

<div class="modal fade" id="addCourseModal" tabindex="-1" aria-labelledby="addCourseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header" style="background: var(--primary-color); color: #fff;">
                <h5 class="modal-title fw-bold d-flex align-items-center" id="addCourseModalLabel">
                    <i class="bi bi-book-half me-2"></i> Đăng khóa học mới
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light p-4">
                <form id="addCourseForm" enctype="multipart/form-data" class="needs-validation" novalidate>
                    <input type="hidden" name="instructor_id" value="{{profile.instructor_id}}">

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Tiêu đề khóa học</label>
                        <input type="text" name="title" class="form-control form-control-lg"
                            placeholder="Nhập tiêu đề khóa học" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Mô tả ngắn</label>
                        <textarea name="description" class="form-control form-control-lg" rows="3"
                            placeholder="Tóm tắt ngắn gọn về khóa học" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Nội dung chi tiết</label>
                        <textarea name="detail_html" class="form-control form-control-lg" rows="7"
                            placeholder="Nhập nội dung chi tiết cho khóa học..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Danh mục</label>
                        <select name="category_id" class="form-select form-select-lg" required>
                            <option value="">-- Chọn lĩnh vực --</option>
                            {{#each categories}}
                            <option value="{{category_id}}">{{name}}</option>
                            {{/each}}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Ảnh đại diện khóa học</label>
                        <input type="file" name="image" class="form-control form-control-lg" accept="image/*" required>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Tổng thời lượng (giờ)</label>
                            <input type="number" name="total_hours" class="form-control" min="0" step="0.1">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Tổng số bài giảng</label>
                            <input type="number" name="total_lectures" class="form-control" min="0">
                        </div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Giá gốc ($)</label>
                            <input type="number" name="original_price" class="form-control" min="0" step="0.01">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Giá khuyến mãi ($)</label>
                            <input type="number" name="current_price" class="form-control" min="0" step="0.01">
                        </div>
                    </div>

                    <div class="text-end">
                        <button type="submit"
                            class="btn-gradient btn-green px-4 py-2 fw-semibold d-inline-flex align-items-center gap-2">
                            <i class="bi bi-save2"></i> Lưu khóa học
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    #addCourseModal .modal-content {
        border-radius: 16px
    }

    #addCourseModal input,
    #addCourseModal textarea,
    #addCourseModal select {
        border-radius: 10px
    }
</style>

<script>
    document.getElementById("addCourseForm")?.addEventListener("submit", async (e) => { e.preventDefault(); const t = new FormData(e.target); const s = await fetch(`/admin/users/add-course/${t.get("instructor_id")}`, { method: "POST", body: t }); const n = await s.json().catch(() => ({})); if (s.ok) { alert("✅ Khóa học đã được thêm thành công!"); location.reload() } else { alert(n.error || "❌ Lỗi khi thêm khóa học.") } });
    document.addEventListener("click", async e => { const n = e.target.closest(".delete-course-btn"); if (!n) return; const t = n.closest("tr"); const s = t.getAttribute("data-course-id"); if (!confirm("Bạn có chắc muốn xóa khóa học này?")) return; const a = await fetch(`/admin/users/delete-course/${s}`, { method: "DELETE" }); if (a.ok) t.remove(); else alert("Không thể xóa khóa học. Vui lòng thử lại.") });
</script>
{{/if}}